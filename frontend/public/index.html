<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Almond Spark</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- Favicon -->
    <link rel="icon" href="images/logo.png" type="image/png">
    <!-- HTMX -->
    <script src="js/htmx.min.js"></script>
    <!-- Alpine.js -->
    <script defer src="js/alpine.min.js"></script>
</head>
<body>
    <nav class="main-nav">
        <ul>
            <li><a href="index.html" class="active">Home</a></li>
            <li><a href="gallery.html">Gallery</a></li>
            <li><a href="personal-note.html">Personal Note</a></li>
        </ul>
    </nav>

    <div class="container">
        <header class="hero">
            <img src="images/topbanner.png" alt="Almond Spark" class="hero-image">
            <div class="title-container">
                <h1 class="main-title">AlmondSpark</h1>
                <p class="tagline">Lighting New Paths to Connection</p>
            </div>
        </header>
        
        <main class="content">
            <section class="generator-section">
                <h2>Generate Your Visual Strip</h2>
                <p class="generator-intro">Enter the idea or sentence you wish to convey and press the button</p>
                
                <div class="generator-form" x-data="{ sentence: '', generating: false }">
                    <div class="input-wrapper">
                        <textarea 
                            class="sentence-input" 
                            placeholder="Type your sentence here..." 
                            x-model="sentence"
                            :disabled="generating"
                        ></textarea>
                    </div>
                    
                    <div class="button-wrapper">
                        <button 
                            class="generate-button"
                            onclick="submitForm()"
                            :disabled="!sentence.trim() || generating"
                        >
                            <span x-show="!generating">Generate Visual</span>
                            <span x-show="generating">Generating...</span>
                        </button>
                    </div>
                    
                    <div id="loading-indicator" class="htmx-indicator">
                        <div class="spinner"></div>
                        <p>Creating your visual strip...</p>
                    </div>
                    
                    <div id="result-area" class="result-container"></div>
                </div>
            </section>
        </main>
    </div>

    <footer>
        <p>&copy; 2025 Almond Spark. All rights reserved.</p>
    </footer>

    <!-- Helper script to process the API response -->
    <script>
        document.addEventListener('htmx:afterSwap', function(event) {
            if (event.detail.target.id === 'result-area') {
                try {
                    const response = JSON.parse(event.detail.xhr.responseText);
                    if (response.image_base64) {
                        const resultArea = document.getElementById('result-area');
                        resultArea.innerHTML = `
                            <h3>Your Visual Strip</h3>
                            <img src="data:image/png;base64,${response.image_base64}" alt="Generated visual strip" class="result-image">
                            <p class="filename">Filename: ${response.filename}</p>
                        `;
                    }
                } catch (e) {
                    console.error('Error processing response:', e);
                }
            }
        });
        
        document.addEventListener('htmx:responseError', function(event) {
            const resultArea = document.getElementById('result-area');
            resultArea.innerHTML = `
                <div class="error-message">
                    <p>Sorry, there was an error generating your image.</p>
                    <p>Error: ${event.detail.xhr.status} ${event.detail.xhr.statusText}</p>
                </div>
            `;
            // Reset the generating state in Alpine
            const form = document.querySelector('[x-data]');
            if (form && form.__x) {
                form.__x.$data.generating = false;
            }
        });

        function submitForm() {
            console.log("Submit form function called");
            
            // Get the form elements
            const textarea = document.querySelector('.sentence-input');
            const button = document.querySelector('.generate-button');
            const loadingIndicator = document.getElementById('loading-indicator');
            const resultArea = document.getElementById('result-area');
            
            // Get the sentence
            const sentence = textarea.value.trim();
            if (!sentence) {
                console.log("No sentence entered");
                return;
            }
            
            console.log("Sending sentence:", sentence);
            
            // Show loading and disable inputs
            loadingIndicator.style.display = 'flex';
            textarea.disabled = true;
            button.disabled = true;
            
            // Update button text if using Alpine
            try {
                if (Alpine) {
                    const generateButtonEl = document.querySelector('.generate-button');
                    const scope = generateButtonEl._x_dataStack[0];
                    if (scope) {
                        scope.generating = true;
                    }
                }
            } catch (e) {
                console.log("Alpine not available or error setting state:", e);
            }
            
            // Change the URL in submitForm to test basic connectivity
            fetch('http://127.0.0.1:8001/api/generate', {  // Change from /api/test to /api/generate
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ sentence: sentence })
            })
            .then(response => {
                console.log("Response received:", response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Data received:", data);
                const resultArea = document.getElementById('result-area');
                resultArea.innerHTML = `
                    <h3>Your Visual Strip</h3>
                    <img src="data:image/png;base64,${data.image_base64}" alt="Generated visual strip" class="result-image">
                    <p class="prompt-text">"${sentence}"</p>
                `;
            })
            .catch(error => {
                console.error('Error details:', error);
                resultArea.innerHTML = `
                    <div class="error-message">
                        <p>Sorry, there was an error generating your image.</p>
                        <p>Error: ${error.message}</p>
                        <p>Make sure your backend server is running at http://127.0.0.1:8001</p>
                    </div>
                `;
            })
            .finally(() => {
                // Hide loading indicator and re-enable inputs
                loadingIndicator.style.display = 'none';
                textarea.disabled = false;
                button.disabled = false;
                
                // Reset Alpine state if possible
                try {
                    if (Alpine) {
                        const generateButtonEl = document.querySelector('.generate-button');
                        const scope = generateButtonEl._x_dataStack[0];
                        if (scope) {
                            scope.generating = false;
                        }
                    }
                } catch (e) {
                    console.log("Alpine not available or error resetting state:", e);
                }
                
                console.log("Request completed");
            });
        }
    </script>
</body>
</html>